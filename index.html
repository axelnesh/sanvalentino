<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>Mini Gioco 2D</title>

<style>

  #startScreen {
  position: fixed;
  inset: 0;
  background: #3a2d2d;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
}

#startBtn {
  width: 220px;
  cursor: pointer;
  transition: transform 0.2s;
}

#startBtn:hover {
  transform: scale(1.05);
}

/* mobile */
@media (max-width: 600px) {
  #startBtn {
    width: 180px;
  }
}  

  #game-wrapper {
  position: relative;
  transform-origin: top center;
}

/* mobile */
@media (max-width: 900px) {
  #game-wrapper {
    transform: scale(0.75);
  }
}

@media (max-width: 700px) {
  #game-wrapper {
    transform: scale(0.6);
  }
}

@media (max-width: 480px) {
  #game-wrapper {
    transform: scale(0.5);
  }
}
body {
  margin: 0;
  background: #3a2d2d;
  display: flex;
  justify-content: center;
  align-items: center;
  height: 100vh;
  font-family: Arial, sans-serif;
}

canvas {
  background: #87ceeb;
  border: 3px solid #000;
  height: auto;
  aspect-ratio: 12 / 5;
  touch-action: none;
}

#dialog {
  position: absolute;
  display: none;
}

.dialog-text {
  background: rgba(0,0,0,0.45);
  padding: 6px 10px;
  border-radius: 6px;
  margin-bottom: 6px;
  color: white;
  text-align: center;
  pointer-events: none;
}

#dialog button {
  background: rgba(255,255,255,0.85);
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
}

#restart img:hover {
  transform: scale(1.1);
  transition: 0.2s;
}

#mobileControls {
  position: absolute;
  bottom: 20px;
  display: flex;
  gap: 20px;
}

#mobileControls button {
  width: 70px;
  height: 70px;
  font-size: 26px;
  border-radius: 50%;
  border: none;
  background: rgba(255,255,255,0.85);
  cursor: pointer;

  /* ðŸ”’ blocca selezione testo e highlight su mobile */
button,
#dialog,
#dialog * {
  -webkit-user-select: none; /* Safari */
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;

  -webkit-tap-highlight-color: transparent; /* iOS */
}
* {
  -webkit-user-select: none !important;
  -webkit-touch-callout: none !important;
  -webkit-tap-highlight-color: rgba(0,0,0,0) !important;
  user-select: none !important;
  outline: none !important;
}

button {
  all: unset; /* rimuove comportamento nativo Safari */
  background: rgba(255,255,255,0.85);
  border-radius: 6px;
  padding: 6px 12px;
  cursor: pointer;
  text-align: center;
}

button:focus {
  outline: none;
}

/* evita selezione accidentale su tutto il gioco */
body {
  -webkit-user-select: none;
  user-select: none;
  -webkit-touch-callout: none; /* menu copia/incolla iOS */
}

  
}
</style>
</head>

<body>

<canvas id="game" width="1200" height="500"></canvas>
<div id="startScreen">
  <img src="start.png" id="startBtn" alt="Start Game">
</div>
<div id="mobileControls">
  <button id="leftBtn">â—€</button>
  <button id="jumpBtn">â¤´</button>
  <button id="rightBtn">â–¶</button>
</div>
<img id="heartImg" src="cuore.gif" style="display:none; position:absolute; width:200px;">

<img id="npcNormal" src="npc1.png" hidden>
<img id="npcTalk"   src="npcTalk.png" hidden>
<img id="npcHappy"  src="npc2.png" hidden>

<div id="dialog">
  <div class="dialog-text">ðŸ‘¤ ALE : Will you be my Valentin?</div>
  <button onclick="answer('si')">SÃ¬</button>
  <button id="noBtn" onclick="answer('no')">No</button>
  <div id="noGif" style="display:none; margin-left:55px; margin-top:-58px;">
    <img src="farfa.gif" width="90">
  </div>
</div>

<div id="restart"
     style="display:none; position:absolute; text-align:center; opacity:0.7; cursor:pointer;"
     onclick="resetGame()">
  <img src="restart.png" width="150">
</div>

<audio id="bgMusic" src="bg.mp3" loop></audio>

<script>
/* ================= SETUP ================= */
let gameStarted = false;
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
function resizeCanvas() {
  const scale = canvas.clientWidth / canvas.width;
  ctx.setTransform(scale, 0, 0, scale, 0, 0);
}
const dialog = document.getElementById("dialog");
const restartDiv = document.getElementById("restart");
const heartImg = document.getElementById("heartImg");
const bgMusic = document.getElementById("bgMusic");
const gravity = 0.8;
const jumpStrength = -12;

const npcImgs = {
  normal: document.getElementById("npcNormal"),
  talk:   document.getElementById("npcTalk"),
  happy:  document.getElementById("npcHappy")
};

const bgImg = new Image();
bgImg.src = "background.png";

const playerImgs = [
  new Image(), // 0 - fermo / base
  new Image(), // 1 - camminata
  new Image()  // 2 - finale (player3)
];


let npcMessage = "";      // testo temporaneo sopra NPC
let npcMessageTime = 0;


playerImgs[0].src = "player1.png";
playerImgs[1].src = "player2.png";
playerImgs[2].src = "player3.png";

let audioStarted = false;
let floatTime = 0;

/* ================= PLAYER ================= */

const player = {
  x: 100,
  y: 200,
  width: 75,
  height: 170,
  speed: 3,
  facing: "right",
  vy: 0,
  isJumping: false,
  currentImg: 0,
  frameCounter: 0,
  finalPose: false
};

/* ================= NPC ================= */

const npc = {
  x: 900,
  y: 250,
  baseY: 250,
  width: 83,
  height: 180,
  vy: 0,
  isJumping: false,
  lastJumpTime: 0,
  state: "normal"
};

const npcJumpStrength = -9;
const npcGravity = 0.4;

/* ================= GAME STATE ================= */

const keys = {};
let dialogShown = false;
let playerLocked = false;
let gameEnded = false;

/* ================= INPUT ================= */
// ðŸ”’ blocca selezione / long press / drag su iOS
["touchstart", "touchmove", "touchend"].forEach(evt => {
  document.addEventListener(evt, e => {
    if (e.target.tagName === "BUTTON") {
      e.preventDefault();
    }
  }, { passive: false });
});

window.addEventListener("keydown", e => {
  if (!audioStarted) {
    bgMusic.volume = 0.4;
    bgMusic.play();
    audioStarted = true;
  }

  keys[e.key] = true;

  if (e.key === " " && !player.isJumping && !playerLocked) {
    player.vy = jumpStrength;
    player.isJumping = true;
  }
});

window.addEventListener("keyup", e => keys[e.key] = false);
const leftBtn  = document.getElementById("leftBtn");
const rightBtn = document.getElementById("rightBtn");
const jumpBtn  = document.getElementById("jumpBtn");

// movimento
leftBtn.addEventListener("touchstart", () => keys["ArrowLeft"] = true);
leftBtn.addEventListener("touchend",   () => keys["ArrowLeft"] = false);

rightBtn.addEventListener("touchstart", () => keys["ArrowRight"] = true);
rightBtn.addEventListener("touchend",   () => keys["ArrowRight"] = false);

// salto
jumpBtn.addEventListener("touchstart", () => {
  if (!player.isJumping && !playerLocked) {
    player.vy = jumpStrength;
    player.isJumping = true;
  }
});

let touchStartX = 0;
let touchStartY = 0;
let touchActive = false;

canvas.addEventListener("touchstart", e => {
  const t = e.touches[0];
  touchStartX = t.clientX;
  touchStartY = t.clientY;
  touchActive = true;
});

canvas.addEventListener("touchend", e => {
  if (!touchActive) return;

  const t = e.changedTouches[0];
  const dx = t.clientX - touchStartX;
  const dy = t.clientY - touchStartY;

  const minSwipe = 40; // sensibilitÃ  swipe


window.addEventListener("resize", resizeCanvas);
window.addEventListener("orientationchange", resizeCanvas);
resizeCanvas();

  // reset
  keys["ArrowLeft"] = false;
  keys["ArrowRight"] = false;

  // swipe orizzontale
  if (Math.abs(dx) > Math.abs(dy) && Math.abs(dx) > minSwipe) {
    if (dx > 0) {
      keys["ArrowRight"] = true;
      setTimeout(() => keys["ArrowRight"] = false, 200);
    } else {
      keys["ArrowLeft"] = true;
      setTimeout(() => keys["ArrowLeft"] = false, 200);
    }
  }

  // swipe verso lâ€™alto = salto
  if (Math.abs(dy) > Math.abs(dx) && dy < -minSwipe) {
    if (!player.isJumping && !playerLocked) {
      player.vy = jumpStrength;
      player.isJumping = true;
    }
  }

  touchActive = false;
});




/* ================= UPDATE ================= */

function update() {
 if (!player.finalPose) {
    if (player.x < 0 || player.x + player.width > canvas.width) {
      npcMessage = "hey, dove vai di bello? ";
      npcMessageTime = Date.now();
    }

    // Sparisce dopo 2 secondi
    if (npcMessage && Date.now() - npcMessageTime > 1500) {
      npcMessage = "";
    }
  }
  // Player movimento
  if (!playerLocked && !player.finalPose) {
    let moving = false;

    if (keys["ArrowRight"]) { player.x += player.speed; player.facing="right"; moving=true; }
    if (keys["ArrowLeft"])  { player.x -= player.speed; player.facing="left"; moving=true; }

    if (moving) {
      player.frameCounter++;
      if (player.frameCounter % 10 === 0)
        player.currentImg = (player.currentImg + 1) % 2;
    } else {
      player.currentImg = 0;
    }
  }

  // GravitÃ 
  player.vy += gravity;
  player.y += player.vy;

  if (player.y + player.height >= 434) {
    player.y = 434 - player.height;
    player.vy = 0;
    player.isJumping = false;
  }

  // Dialogo NPC
  const distance = Math.abs(player.x - npc.x);
  if (distance < 60 && !dialogShown) {
    dialogShown = true;
    playerLocked = true;
    npc.state = "talk";
    dialog.style.display = "block";
  }

  if (dialogShown) {
    floatTime += 0.05;
    dialog.style.left = canvas.offsetLeft + npc.x - 20 + "px";
    dialog.style.top  = canvas.offsetTop + npc.y - 90 + Math.sin(floatTime)*5 + "px";
  }

  // NPC salta se felice
  if (gameEnded) {
    const now = Date.now();
    if (!npc.isJumping && now - npc.lastJumpTime > 2000) {
      npc.vy = npcJumpStrength;
      npc.isJumping = true;
      npc.lastJumpTime = now;
    }

    if (npc.isJumping) {
      npc.vy += npcGravity;
      npc.y += npc.vy;
      npc.state = "happy";

      if (npc.y >= npc.baseY) {
        npc.y = npc.baseY;
        npc.vy = 0;
        npc.isJumping = false;
        npc.state = "normal"; 
      }
    }
  
  }
}

/* ================= DRAW ================= */

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.drawImage(bgImg,0,0,canvas.width,canvas.height);

  // Player
  ctx.save();
  const playerImg = player.finalPose ? playerImgs[2] : playerImgs[player.currentImg];
  if (player.facing==="left") {
    ctx.translate(player.x + player.width/2,0);
    ctx.scale(-1,1);
    ctx.drawImage(playerImg,-player.width/2,player.y,player.width,player.height);
  } else {
    ctx.drawImage(playerImg,player.x,player.y,player.width,player.height);
  }
  ctx.restore();

  // NPC
  ctx.drawImage(npcImgs[npc.state],npc.x,npc.y,npc.width,npc.height);
  if (npcMessage) {
    const padding = 6;
    ctx.font = "16px Arial";
    ctx.textAlign = "center";
    const textWidth = ctx.measureText(npcMessage).width;
    const boxWidth = textWidth + padding*2;
    const boxHeight = 24;

    // Box trasparente nero
    ctx.fillStyle = "rgba(0,0,0,0.5)";
    ctx.fillRect(
      npc.x + npc.width/2 - boxWidth/2,
      npc.y - 30 - boxHeight/2,
      boxWidth,
      boxHeight
    );

    // Testo giallo sopra box
    ctx.fillStyle = "white";
    ctx.fillText(npcMessage, npc.x + npc.width/2, npc.y - 26);
  }
}

/* ================= UI ================= */

function answer(choice) {
  if (choice==="no") {
    document.getElementById("noBtn").style.display="none";
    document.getElementById("noGif").style.display="block";
    return;
  }

  // SÃ¬ â†’ player3 e npc felice
  dialog.style.display="none";
  player.finalPose = true;
  player.currentImg = 2;
  playerLocked = true;

  npc.state = "happy";
  gameEnded = true;

  // Cuore e restart
  heartImg.style.display="block";
  heartImg.style.left = canvas.offsetLeft + canvas.width/2 - 100 + "px";
  heartImg.style.top = canvas.offsetTop + 80 + "px";

  restartDiv.style.display="block";
  restartDiv.style.left = canvas.offsetLeft + canvas.width/2 - 75 + "px";
  restartDiv.style.top = canvas.offsetTop + 300 + "px";
}



function resetGame() {
  location.reload();
}

/* ================= LOOP ================= */

function loop() {
  if (gameStarted) {
    update();
    draw();
  }
  requestAnimationFrame(loop);
}
loop();

const startScreen = document.getElementById("startScreen");
const startBtn = document.getElementById("startBtn");

startBtn.addEventListener("click", () => {
  startScreen.style.display = "none";
  gameStarted = true;

  // musica (iOS friendly)
  bgMusic.volume = 0.4;
  bgMusic.play();
});
</script>

</body>
</html>
