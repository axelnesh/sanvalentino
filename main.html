<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Mini Gioco 2D</title>
  <style>
    body {
      margin: 0;
      background: #3a2d2d;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      color: white;
      font-family: Arial, sans-serif;
    }

    canvas {
      background: #87ceeb;
      border: 3px solid #000;
    }

    
    #dialog {
  position: absolute;
  display: none;
  pointer-events: auto;
}

#dialog button {
  background: rgba(255,255,255,0.85);
  border: none;
  border-radius: 6px;
  padding: 6px 12px;
  font-size: 14px;
  cursor: pointer;
}

#dialog button:hover {
  background: white;
}
 
.dialog-text {
  background: rgba(0, 0, 0, 0.45); /* trasparenza leggera */
  padding: 6px 10px;
  border-radius: 6px;
  margin-bottom: 6px;
  font-size: 14px;
  text-align: center;
  pointer-events: none; /* importantissimo: non blocca i click */
}
   


    button {
      margin-top: 5px;
      padding: 10px 20px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<canvas id="game" width="1200" height="500"></canvas>
<img id="heartImg"
     src="cuore.gif"
     style="display:none; position:absolute; width:200px;">

<div id="dialog">
    <div class="dialog-text">
        ðŸ‘¤ ALE : Will you be my Valentin?
      </div>
    <button onclick="answer('si')">SÃ¬</button>
    <button id="noBtn" onclick="answer('no')">No</button>
    <div id="noGif" style="display:none; margin-left:55px; margin-top:-58px;">
      <img src="farfa.gif" width="90">
    </div>
  </div>
  
  <div id="restart" style="
  display:none;
  position:absolute;
  text-align:center;
  opacity:0.7;
  font-size:14px;">
  <p>Vuoi rigiocare?</p>
  <img src="restart.png"
       style="width:80px; margin-top:5px;">
</div>
<audio id="bgMusic" src="bg.mp3" loop></audio>
 
<script>
    let floatTime = 0;
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    const bgMusic = document.getElementById("bgMusic");
    let audioStarted = false;
    ctx.font = "16px Arial";

// Immagini bkg
    const bgImg = new Image();
bgImg.src = "background.png";


    // Immagini player (due frame) e NPC
    const playerImgs = [new Image(), new Image()];
    playerImgs[0].src = "player1.png";
    playerImgs[1].src = "player2.png";
    
    const npcImg = new Image();
    npcImg.src = "npc.png";
    
    // Player
    const player = {
      x: 850,
      y: 200,
      width: 75,
      height: 170,
      speed: 3,
      facing: "right",
      vy: 0,
      isJumping: false,
      currentImg: 0,
      frameCounter: 0
    };
    
    // NPC
    const npc = {
      x: 900,
      y: 250,
      width: 83,
      height: 180
    };
    
    // Stato gioco
    const keys = {};
    let dialogShown = false;
    let playerLocked = false;
    let showHeart = false;
    let gameEnded = false;
    
    const gravity = 0.8;
    const jumpStrength = -12;
    
    // Input tastiera
    window.addEventListener("keydown", e => {
  if (!audioStarted) {
    bgMusic.volume = 0.4;
    bgMusic.play();
    audioStarted = true;
  }

  keys[e.key] = true;

  if (e.key === " " && !player.isJumping && !playerLocked) {
    player.vy = jumpStrength;
    player.isJumping = true;
    jumpSound.play();
  }
});
    window.addEventListener("keyup", e => keys[e.key] = false);
    
    // Funzione reset gioco
    function resetGame() {
  // reset player
  player.x = 40;
  player.y = 120;
  player.vy = 0;
  player.isJumping = false;
  playerLocked = false;

  // stati
  dialogShown = false;
  showHeart = false;
  gameEnded = false;

  // dialog NPC
  dialog.style.display = "none";
  document.getElementById("noBtn").style.display = "inline-block";
  document.getElementById("noGif").style.display = "none";

  // cuore e restart
  document.getElementById("heartImg").style.display = "none";
  restartDiv.style.display = "none";

  // animazione
  player.currentImg = 0;
  player.frameCounter = 0;

  // musica
  bgMusic.currentTime = 0;
  bgMusic.play();
}

    const restartDiv = document.getElementById("restart");
    const noRestartBtn = document.getElementById("noRestart");

    function update() {
        
      if (!playerLocked) {
        let moving = false;
        if (keys["ArrowRight"]) {
          player.x += player.speed;
          player.facing = "right";
          moving = true;
        }
        if (keys["ArrowLeft"]) {
          player.x -= player.speed;
          player.facing = "left";
          moving = true;
        }
    
        // Animazione camminata
        if(moving) {
          player.frameCounter++;
          if(player.frameCounter % 10 === 0) {
            player.currentImg = (player.currentImg + 1) % 2;
          }
        } else {
          player.currentImg = 0; // immobile usa prima immagine
          player.frameCounter = 0;
        }
      }
    
      // Limiti orizzontali
      player.x = Math.max(0, Math.min(canvas.width - player.width, player.x));
    
      // Salto e gravitÃ 
      player.vy += gravity;
      player.y += player.vy;
    
      // Terreno
      if(player.y + player.height >= 434) {
        player.y = 434 - player.height;
        player.vy = 0;
        player.isJumping = false;
      }
    
      // Distanza player-NPC
      const distance = Math.abs(player.x - npc.x);
      if (distance < 60 && !dialogShown) {
        dialog.style.display = "block";
        dialogShown = true;
        playerLocked = true;
      }
      if (dialogShown) {
        floatTime += 0.05;

        const floatOffset = Math.sin(floatTime) * 5;

        dialog.style.left = (canvas.offsetLeft + npc.x - 20) + "px";
        dialog.style.top =
            (canvas.offsetTop + npc.y - 90 + floatOffset) + "px";
      }
      if (gameEnded) {
  const heart = document.getElementById("heartImg");

  heart.style.display = "block";
  heart.style.left =
    (canvas.offsetLeft + canvas.width / 2 - 100) + "px";
  heart.style.top =
    (canvas.offsetTop + 80) + "px";

  restartDiv.style.display = "block";
  restartDiv.style.left =
    (canvas.offsetLeft + canvas.width / 2 - 60) + "px";
  restartDiv.style.top =
    (canvas.offsetTop + 300) + "px";
}

    }
   
    
   
    
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    
      // sfondo
  if(bgImg.complete) ctx.drawImage(bgImg,0,0,canvas.width,canvas.height);



    
      // Player con flip e animazione
      if(playerImgs[player.currentImg].complete) {
        ctx.save();
        if(player.facing==="left") {
          ctx.translate(player.x + player.width/2,0);
          ctx.scale(-1,1);
          ctx.drawImage(playerImgs[player.currentImg], -player.width/2, player.y, player.width, player.height);
        } else {
          ctx.drawImage(playerImgs[player.currentImg], player.x, player.y, player.width, player.height);
        }
        ctx.restore();
      }
    
      // NPC
      if(npcImg.complete) ctx.drawImage(npcImg, npc.x, npc.y, npc.width, npc.height);
    
     
    

      
    }
    
    function answer(choice) {
  if (choice === "no") {
    // NO: il gioco continua
    noClicked = true;


    // Nasconde il bottone NO
    document.getElementById("noBtn").style.display = "none";

    // Mostra la GIF
    document.getElementById("noGif").style.display = "block";

    return; // â›” IMPORTANTISSIMO: non chiude il gioco
  }

  if (choice === "si") {
    // SÃŒ: fine gioco
    dialog.style.display = "none";
    showHeart = true;
    gameEnded = true;
  
  }
}

    
    
    // Loop principale
    function loop() {
      update();
      draw();
    
     
    
      requestAnimationFrame(loop);
    }
    
    loop();
    </script>
    

  

</body>
</html>